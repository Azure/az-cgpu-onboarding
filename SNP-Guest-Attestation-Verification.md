# Overview
There are several ways to perform guest attestation for Azure SEV-SNP CVMs.

Here are some documentation links that contain more information on how to do so using different tools and services:
- [Guest Attestation with AMD Sev Tool](https://github.com/Azure/confidential-computing-cvm-guest-attestation/blob/main/cvm-guest-attestation.md#linux)
- [Guest Attestation with MAA](https://github.com/Azure/confidential-computing-cvm-guest-attestation/tree/main/cvm-attestation-sample-app)

Below are the detailed steps that you can follow in order to retrieve the SNP report from your device and how to validate it using the AMD SEV-SNP tool, the VirTEE snpguest tool, or MAA service.

# Retrieve SNP report

1. Fetch the AMD VCEK certificate from the Azure IMDS endpoint
    ```
    sudo apt update && sudo apt install -y jq
    mkdir ~/snp_attestation
    cd ~/snp_attestation
    curl -H Metadata:true http://169.254.169.254/metadata/THIM/amd/certification > vcek
    cat ./vcek | jq -r '.vcekCert , .certificateChain' > ./vcek.pem
    ```

2. Extract the SNP guest report from the vTPM NVRAM. **Please note, the report is pre-generated by the HCL at boot time. It is NOT a dynamically generated attestation report.**

    ```
    sudo apt update && sudo apt install -y tpm2-tools
    cd ~/snp_attestation
    sudo tpm2_nvread -C o 0x01400001 > ./snp_report.bin
    dd skip=32 bs=1 count=1184 if=./snp_report.bin of=./guest_report.bin
    ```

# Validate report

1. Validate the report with AMD SEV Tool

    First build and install the AMD SEV Tool:
    ```
    cd ~/snp_attestation
    git clone https://github.com/AMDESE/sev-tool.git && cd sev-tool
    sudo bash deps-install.sh
    autoreconf -vif && ./configure && make && cp src/sevtool .
    ```

    Then run the validation:
    ```
    sudo ~/snp_attestation/sev-tool/sevtool --ofolder ~/snp_attestation --validate_guest_report
    ```

    You should see the following output:
    ```
    Guest report validated successfully!

    Command Successful
    ```

2. Validate the report with VirTEE snpguest tool

    First build and install the VirTEE snpguest tool:
    ```
    cd ~/snp_attestation
    git clone https://github.com/virtee/snpguest.git && cd snpguest
    sudo apt update && sudo apt install -y build-essential
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
    source "$HOME/.cargo/env"
    cargo build -r
    ```

    Then run the validation:
    ```
    ~/snp_attestation/snpguest/target/release/snpguest verify attestation ~/snp_attestation ~/snp_attestation/guest_report.bin
    ```

    You should see the following output:
    ```
    Reported TCB Boot Loader from certificate matches the attestation report.
    Reported TCB TEE from certificate matches the attestation report.
    Reported TCB SNP from certificate matches the attestation report.
    Reported TCB Microcode from certificate matches the attestation report.
    Chip ID from certificate matches the attestation report.
    VEK signed the Attestation Report!
    ```

5. Guest Attestation with MAA

    First build and install the azure guest attestation package:
    ```
    cd ~/snp_attestation
    git clone https://github.com/Azure/confidential-computing-cvm-guest-attestation.git
    cd confidential-computing-cvm-guest-attestation/cvm-attestation-sample-app
    sudo apt update && sudo apt install -y build-essential libcurl4-openssl-dev libjsoncpp-dev libboost-all-dev cmake nlohmann-json3-dev
    wget https://packages.microsoft.com/repos/azurecore/pool/main/a/azguestattestation1/azguestattestation1_1.0.5_amd64.deb
    sudo dpkg -i azguestattestation1_1.0.5_amd64.deb
    cmake . && make
    ```

    Then run the attestation client from the sample app:
    ```
    cd ~/snp_attestation/confidential-computing-cvm-guest-attestation/cvm-attestation-sample-app
    sudo ./AttestationClient -o token
    ```

    The output is an JWT Entity Attestation Token (EAT). You can view the EAT in the decoded format using the following command.
    ```
    sudo ./AttestationClient -o token | jq -R 'split(".") | .[0],.[1] | @base64d | fromjson'
    ```
 
